<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mec√°nico - CRM Flota PepsiCo</title>
    <link rel="stylesheet" href="assets/css/style-mecanico.css" />
    <link rel="stylesheet" href="assets/css/logout_button.css">
</head>

<body>
    <header class="header">
        <div class="logo">
            <h1>CRM Flota PepsiCo</h1>
        </div>
        <div class="user-info">
            <span class="user-role">Mec√°nico</span>
            <span id="userName">‚Äî</span>
            <div class="notifications-wrapper" style="position: relative;">
                <button id="notificationsBtn" class="btn btn-secondary" style="position: relative; margin-right: 10px;">
                    üîî Notificaciones
                    <span id="notificationsBadge" class="notification-badge" style="display: none; position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div id="notificationsPanel" class="notifications-panel" style="display: none; position: absolute; top: 100%; right: 0; width: 400px; max-height: 500px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; margin-top: 10px;">
                    <div class="notifications-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 16px;">Notificaciones</h3>
                        <button onclick="NotificationsManager.markAllAsRead()" class="btn btn-sm btn-secondary" style="font-size: 12px;">Marcar todas como le√≠das</button>
                    </div>
                    <div class="notifications-content" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                        <div class="notification-empty">Cargando...</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" id="btnLogout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <nav class="nav-container">
        <ul class="nav-menu">
            <li><a href="#" class="active" data-tab="dashboard">Dashboard</a></li>
            <li><a href="#" id="navHistorial">Historial</a></li>
            <li><a href="#" data-tab="stock">Stock</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <!-- Contenedor para notificaciones flotantes -->
        <div id="notificationsContainer" style="position: fixed; top: 80px; right: 20px; z-index: 10000; max-width: 400px;"></div>
        
        <div class="page-title">
            <h2>Dashboard Mec√°nico</h2>
            <button class="btn btn-secondary" id="btnRefreshTasks">Actualizar</button>
        </div>

        <section class="stats-grid">
            <article class="stat-card">
                <h3>Tareas asignadas</h3>
                <div class="stat-number" id="statAsignadas">‚Äî</div>
            </article>
            <article class="stat-card">
                <h3>En proceso</h3>
                <div class="stat-number" id="statEnProceso">‚Äî</div>
            </article>
            <article class="stat-card">
                <h3>En espera de repuestos</h3>
                <div class="stat-number" id="statEspera">‚Äî</div>
            </article>
            <article class="stat-card">
                <h3>Listas para revisi√≥n</h3>
                <div class="stat-number" id="statListas">‚Äî</div>
            </article>
        </section>

        <section id="tab-dashboard" class="tab">
            <div class="panel-grid">
            <article class="panel panel-list">
                <div class="panel-header">
                    <div>
                        <h3>OT asignadas</h3>
                        <p>Selecciona una orden para ver los detalles y registrar acciones.</p>
                    </div>
                </div>
                <!-- Controles de filtro -->
                <div class="filters-container" style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="filterPatente" style="display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; color: #495057;">Patente</label>
                        <input type="text" id="filterPatente" placeholder="Buscar por patente..." style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label for="filterChofer" style="display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; color: #495057;">Chofer</label>
                        <input type="text" id="filterChofer" placeholder="Buscar por chofer..." style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label for="filterFecha" style="display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; color: #495057;">Fecha</label>
                        <input type="date" id="filterFecha" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="btnAplicarFiltros" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">Filtrar</button>
                        <button type="button" id="btnLimpiarFiltros" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">Limpiar</button>
                    </div>
                </div>
                <div id="taskList" class="task-list">
                    <div class="empty-state">Cargando √≥rdenes...</div>
                </div>
                <div id="taskListPagination"></div>
            </article>

            <article class="panel panel-detail" id="taskDetail">
                <div class="empty-state">Selecciona una orden de la lista para ver su informaci√≥n.</div>
            </article>
            </div>
        </section>

        <!-- Secci√≥n de Stock (oculta por defecto, se muestra al hacer clic en nav-item Stock) -->
        <section id="tab-stock" class="tab" style="display: none;">
            <div class="page-title">
                <h2>Stock de Repuestos</h2>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="stockMecanicoReload()">Actualizar</button>
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <h3 class="stat-number" id="stock-total-repuestos-mec">...</h3>
                    <p>Total Repuestos</p>
                </div>
                <div class="stat-card">
                    <h3 class="stat-number" id="stock-bajo-mec">...</h3>
                    <p>Stock Bajo</p>
                </div>
                <div class="stat-card">
                    <h3 class="stat-number" id="stock-critico-mec">...</h3>
                    <p>Stock Cr√≠tico</p>
                </div>
            </div>

            <div class="table-container">
                <h3 style="padding: 20px 25px; background:#f8f9fa; border-bottom:1px solid #eee;">Inventario Actual</h3>
                <table id="stockMecanicoTabla">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Repuesto</th>
                            <th>Stock Actual</th>
                            <th>M√≠nimo</th>
                            <th>M√°ximo</th>
                            <th>Ubicaci√≥n</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="stockMecanicoTBody">
                        <tr><td colspan="7" style="text-align:center;padding:20px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="modal" id="modalDiagnostic" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Iniciar diagn√≥stico</h3>
                <button class="close-btn" onclick="closeDiagnosticModal()">&times;</button>
            </div>
            <form id="diagnosticForm">
                <input type="hidden" id="diagnostic_task_id" />
                <div class="form-info">
                    <p><strong>OT:</strong> <span id="diagnostic_ot_label">‚Äî</span></p>
                    <p><strong>Veh√≠culo:</strong> <span id="diagnostic_vehicle_label">‚Äî</span></p>
                </div>

                <div class="form-group">
                    <label for="diagnostic_fecha_inicio">Fecha y hora de inicio real (*)</label>
                    <input type="datetime-local" id="diagnostic_fecha_inicio" required />
                    <div class="form-hint">Usamos esta fecha para registrar el inicio del trabajo y actualizar la OT.</div>
                </div>

                <div class="form-group">
                    <label for="diagnostic_inicial">Diagn√≥stico Inicial (*)</label>
                    <textarea id="diagnostic_inicial" rows="4" placeholder="Describe el diagn√≥stico inicial del problema..." required></textarea>
                    <div class="form-hint">Describe los hallazgos y el diagn√≥stico realizado.</div>
                </div>

                <div class="form-group">
                    <label>Discrepancia (*)</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="diagnostic_discrepancia" value="no" checked>
                            <span>No</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="diagnostic_discrepancia" value="si">
                            <span>S√≠</span>
                        </label>
                    </div>
                    <div class="form-hint">¬øHay discrepancia entre tu diagn√≥stico y el reporte inicial del cliente/conductor?</div>
                </div>

                <div class="form-group" id="diagnostic_discrepancia_detalle_group" style="display: none;">
                    <label for="diagnostic_discrepancia_detalle">Detalle Discrepancia (*)</label>
                    <textarea id="diagnostic_discrepancia_detalle" rows="3" placeholder="Explica la diferencia con el reporte inicial..."></textarea>
                    <div class="form-hint">Describe las diferencias encontradas respecto al reporte inicial.</div>
                </div>

                <div class="form-group" id="diagnostic_prioridad_group" style="display: none;">
                    <label for="diagnostic_prioridad">Prioridad Diagnosticada (*)</label>
                    <select id="diagnostic_prioridad">
                        <option value="BAJA">Baja</option>
                        <option value="NORMAL" selected>Normal</option>
                        <option value="ALTA">Alta</option>
                        <option value="URGENTE">Urgente</option>
                    </select>
                    <div class="form-hint">Prioridad basada en el diagn√≥stico realizado (solo si hay discrepancia).</div>
                </div>

                <div class="form-group">
                    <label>Checklist de diagn√≥stico (*)</label>
                    <div class="form-hint" style="margin-bottom: 10px;">Debes marcar al menos un item o "Checklist completo" para continuar.</div>
                    <div class="checklist-grid">
                        <label class="checklist-item">
                            <input type="checkbox" id="diag_check_visual" />
                            Inspecci√≥n visual
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="diag_check_escaner" />
                            Esc√°ner electr√≥nico
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="diag_check_prueba" />
                            Prueba en ruta
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="diag_check_seguridad" />
                            Sistemas de seguridad
                        </label>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="diag_check_all_ok" />
                        Checklist completo
                    </label>
                </div>

                <div class="form-group">
                    <label for="diagnostic_evidencias">Evidencias (opcional)</label>
                    <input type="file" id="diagnostic_evidencias" accept="image/jpeg,image/png,image/webp,application/pdf,text/plain,.jpg,.jpeg,.png,.webp,.pdf,.txt,.doc,.docx" multiple />
                    <div class="form-hint">Hasta 5 archivos (JPG, PNG, WEBP, PDF, TXT, DOC, DOCX) para respaldar el diagn√≥stico.</div>
                    <ul id="diagnostic_evidencias_list" class="file-list"></ul>
                </div>

                <div class="form-group">
                    <label for="diagnostic_notas">Notas adicionales (opcional)</label>
                    <textarea id="diagnostic_notas" rows="2" placeholder="Notas adicionales o comentarios..."></textarea>
                </div>

            <div class="form-actions">
                <span id="diagnosticMsg" class="status hidden"></span>
                <button type="button" class="btn btn-secondary" onclick="closeDiagnosticModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Registrar inicio</button>
            </div>
            </form>
        </div>
    </div>

        <!-- Modal gen√©rico de confirmaci√≥n de acci√≥n -->
    <div class="modal" id="modalConfirmAction" aria-hidden="true">
        <div class="modal-content modal-confirm">
            <div class="modal-header">
                <h3 id="confirmActionTitle">Confirmar acci√≥n</h3>
                <button class="close-btn" onclick="closeConfirmActionModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px 24px;">
                <p id="confirmActionMessage" class="confirm-message">
                    <!-- Mensaje din√°mico -->
                </p>
            </div>
            <div class="form-actions" style="padding: 0 24px 20px 24px;">
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="confirmActionCancelBtn">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmActionOkBtn">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Solicitar Repuestos -->
    <div class="modal" id="modalSolicitarRepuestos">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Solicitar Repuestos</h3>
                <button class="close-btn" onclick="closeModal('modalSolicitarRepuestos')">&times;</button>
            </div>
            <form id="solicitarRepuestosForm">
                <input type="hidden" id="sol_rep_ot_id" />
                <div class="form-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <p><strong>OT:</strong> <span id="sol_rep_ot_label">‚Äî</span></p>
                    <p><strong>Veh√≠culo:</strong> <span id="sol_rep_vehiculo_label">‚Äî</span></p>
                </div>
                
                <div class="form-group">
                    <label>Repuestos a Solicitar</label>
                    <div id="repuestosListContainer" style="margin-bottom: 15px;">
                        <!-- Las filas de repuestos se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" id="btnAgregarRepuesto" style="margin-bottom: 15px;">
                        + Agregar Repuesto
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="sol_rep_comentarios">Comentarios Generales (opcional)</label>
                    <textarea id="sol_rep_comentarios" rows="3" placeholder="Informaci√≥n adicional sobre la solicitud..."></textarea>
                </div>
                
                <div class="form-actions">
                    <span id="solRepMsg" class="status hidden"></span>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modalSolicitarRepuestos')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar Solicitudes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Recepci√≥n de Repuestos -->
    <div class="modal" id="modalConfirmarRecepcion" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Recepci√≥n de Repuestos</h3>
                <button class="close-btn" onclick="closeModal('modalConfirmarRecepcion')">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p>¬øConfirmas que has recibido los siguientes repuestos?</p>
                <div id="recepcionRepuestosList" style="margin: 20px 0;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div class="form-actions" style="border-top: none; padding-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modalConfirmarRecepcion')">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarRecepcion">Confirmar Recepci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Historial de OTs -->
    <div class="modal" id="modalHistorial" aria-hidden="true" style="display: none;">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Historial de √ìrdenes de Trabajo</h3>
                <button class="close-btn" onclick="closeHistorialModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="historialContainer" style="min-height: 400px;">
                    <!-- HistoryViewer se inicializar√° aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Cierre de Trabajo -->
    <div class="modal" id="modalCierreTrabajo" aria-hidden="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Cierre de Trabajo</h3>
                <button class="close-btn" onclick="closeModal('modalCierreTrabajo')">&times;</button>
            </div>
            <form id="cierreTrabajoForm">
                <input type="hidden" id="cierre_task_id" />
                <div class="form-info">
                    <p><strong>OT:</strong> <span id="cierre_ot_label">‚Äî</span></p>
                    <p><strong>Veh√≠culo:</strong> <span id="cierre_vehicle_label">‚Äî</span></p>
                </div>

                <div class="form-group">
                    <label for="cierre_descripcion">Descripci√≥n del Proceso Realizado (*)</label>
                    <textarea id="cierre_descripcion" rows="6" placeholder="Describe detalladamente el proceso realizado, las reparaciones efectuadas, y cualquier observaci√≥n relevante..." required></textarea>
                    <div class="form-hint">Este campo es obligatorio. Describe el trabajo realizado de manera clara y completa.</div>
                </div>

                <div class="form-group">
                    <label for="cierre_evidencias">Adjuntar Evidencia (opcional)</label>
                    <input type="file" id="cierre_evidencias" accept="image/jpeg,image/png,image/webp,application/pdf,text/plain,.jpg,.jpeg,.png,.webp,.pdf,.txt,.doc,.docx" multiple />
                    <div class="form-hint">Puedes adjuntar archivos que respalden el trabajo realizado (m√°ximo 10). Formatos: JPG, PNG, WEBP, PDF, TXT, DOC, DOCX.</div>
                    <ul id="cierre_evidencias_list" class="file-list"></ul>
                </div>

                <div class="form-actions">
                    <span id="cierreMsg" class="status hidden"></span>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modalCierreTrabajo')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar para Verificaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- M√≥dulo de autenticaci√≥n (debe cargarse primero) -->
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/offline-handler.js"></script>
    <script src="assets/js/validations.js"></script>
    <script src="assets/js/file-utils.js"></script>
    <script src="assets/js/pagination.js"></script>
    <script src="assets/js/filters-search.js"></script>
    <script src="assets/js/history-viewer.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/logout_button.js"></script>
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/loading-utils.js"></script>
    <script src="assets/js/notifications-manager.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="assets/js/mecanico_dashboard.js" defer></script>
</body>

</html>